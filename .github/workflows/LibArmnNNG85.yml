name: ArmNN for MediaTek Helio G85 (Optimized & Fixed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      NDK_VER: "r27b"
      ARM_TAG: "v24.11"
      FB_TAG: "v23.5.26"
      NDK_ROOT: "${{ github.workspace }}/android-ndk-r27b"
      ANDROID_NDK: "${{ github.workspace }}/android-ndk-r27b"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Environment
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ninja-build wget unzip git python3
          wget -qO- https://cmake.org/files/v3.31/cmake-3.31.0-linux-x86_64.tar.gz | sudo tar --strip-components=1 -xzC /usr/local

      - name: Download NDK with Retry
        run: |
          for i in {1..3}; do
            wget -q https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VER }}-linux.zip && break || sleep 15
          done
          unzip -q android-ndk-${{ env.NDK_VER }}-linux.zip

      - name: Verify NDK Compiler is Accessible
        run: |
          if [ ! -f "${{ env.NDK_ROOT }}/toolchains/llvm/prebuilt/linux-x86_64/bin/clang++" ]; then
            echo "FATAL: clang++ not found in NDK!"
            exit 1
          fi
          export PATH="${{ env.NDK_ROOT }}/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          which clang++
          clang++ --version

      - name: Clone Dependencies with Retry
        run: |
          clone_with_retry() {
            for i in {1..3}; do
              git clone --depth 1 --branch "$1" "$2" "$3" && return 0 || sleep 15
            done
            return 1
          }
          clone_with_retry ${{ env.ARM_TAG }} https://github.com/ARM-software/ComputeLibrary.git ComputeLibrary
          clone_with_retry ${{ env.ARM_TAG }} https://github.com/ARM-software/armnn.git armnn
          clone_with_retry ${{ env.FB_TAG }} https://github.com/google/flatbuffers.git flatbuffers

      - name: Build FlatBuffers and flatc
        run: |
          mkdir -p flatbuffers/build && cd flatbuffers/build
          cmake .. -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.NDK_ROOT }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-35 \
            -DCMAKE_BUILD_TYPE=Release \
            -DFLATBUFFERS_BUILD_TESTS=OFF \
            -DFLATBUFFERS_BUILD_SHAREDLIB=OFF \
            -DFLATBUFFERS_BUILD_FLATC=ON
          ninja

      - name: Build ACL with Helio G85 Optimizations + Fix Unknown Warnings
        run: |
          cd ComputeLibrary
          mkdir build && cd build
          cmake .. -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.NDK_ROOT }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-35 \
            -DCMAKE_BUILD_TYPE=Release \
            -DARM_COMPUTE_GRAPH=ON \
            -DARM_COMPUTE_OPENCL=ON \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_CXX_FLAGS="-mcpu=cortex-a55 -mtune=cortex-a55 -O3 -flto -fno-exceptions -fno-rtti -Wno-unknown-warning-option" \
            -DCMAKE_C_FLAGS="-mcpu=cortex-a55 -mtune=cortex-a55 -O3 -flto -Wno-unknown-warning-option" \
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON
          ninja

          cp libarm_compute-static.a libarm_compute.a
          cp libarm_compute_core-static.a libarm_compute_core.a
          cp libarm_compute_graph-static.a libarm_compute_graph.a

          mkdir -p release debug
          cp libarm_compute*.a release/
          cp libarm_compute*.a debug/

      - name: Build ArmNN with Full Optimizations
        run: |
          mkdir -p armnn/build && cd armnn/build
          cmake .. -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.NDK_ROOT }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-35 \
            -DCMAKE_BUILD_TYPE=Release \
            -DARMCOMPUTE_ROOT=${{ github.workspace }}/ComputeLibrary \
            -DARMCOMPUTE_BUILD_DIR=${{ github.workspace }}/ComputeLibrary/build \
            -DFLATBUFFERS_ROOT=${{ github.workspace }}/flatbuffers \
            -DFLATBUFFERS_LIBRARY=${{ github.workspace }}/flatbuffers/build/libflatbuffers.a \
            -DFLATC=${{ github.workspace }}/flatbuffers/build/flatc \
            -DARMCOMPUTENEON=1 \
            -DARMCOMPUTECL=1 \
            -DBUILD_UNIT_TESTS=OFF \
            -DCMAKE_CXX_FLAGS="-mcpu=cortex-a55 -mtune=cortex-a55 -O3 -flto -fno-exceptions -fno-rtti -Wno-unknown-warning-option" \
            -DCMAKE_INTERPROCEDURAL_OPTIMIZATION=ON \
            -DCMAKE_SHARED_LINKER_FLAGS="-Wl,-z,max-page-size=16384" \
            -DCMAKE_EXE_LINKER_FLAGS="-Wl,-z,max-page-size=16384"

          for i in {1..3}; do
            ninja && break || sleep 20
          done

      - name: Package Final Binary
        run: |
          if [ ! -f "armnn/build/libarmnn.so" ]; then
            echo "FATAL: libarmnn.so not found after build."
            exit 1
          fi
          zip -j ArmNN_HelioG85_Optimized_Android16.zip armnn/build/libarmnn.so

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArmNN-HelioG85-Optimized
          path: ArmNN_HelioG85_Optimized_Android16.zip
