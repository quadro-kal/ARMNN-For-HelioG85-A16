name: ArmNN Android 16 - Ultimate Resilience

on:
  workflow_dispatch:

jobs:
  build-armnn:
    runs-on: ubuntu-latest
    env:
      NDK_VER: "r27b"
      ARM_TAG: "v24.11"
      FB_TAG: "v23.5.26"
      # Definisi path untuk mempermudah pemeliharaan
      NDK_PATH: "${{ github.workspace }}/android-ndk-r27b"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Tools & CMake 3.31
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ninja-build wget unzip git python3
          wget -qO- https://cmake.org/files/v3.31/cmake-3.31.0-linux-x86_64.tar.gz | sudo tar --strip-components=1 -xzC /usr/local

      - name: Download NDK with Retry
        run: |
          retry_count=0
          until [ $retry_count -ge 3 ]
          do
            wget -q https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VER }}-linux.zip && break
            retry_count=$((retry_count+1))
            echo "Retry NDK download: $retry_count"
            sleep 5
          done
          unzip -q android-ndk-${{ env.NDK_VER }}-linux.zip

      - name: Clone Repositories with Retry
        run: |
          function retry_clone() {
            local url=$1
            local branch=$2
            local dir=$3
            local count=0
            until [ $count -ge 3 ]
            do
              git clone --depth 1 --branch $branch $url $dir && return 0
              count=$((count+1))
              echo "Retry cloning $dir: $count"
              sleep 5
            done
            return 1
          }
          
          retry_clone https://github.com/ARM-software/ComputeLibrary.git ${{ env.ARM_TAG }} ComputeLibrary
          retry_clone https://github.com/ARM-software/armnn.git ${{ env.ARM_TAG }} armnn
          retry_clone https://github.com/google/flatbuffers.git ${{ env.FB_TAG }} flatbuffers

      - name: Build FlatBuffers (Static)
        run: |
          mkdir -p flatbuffers/build && cd flatbuffers/build
          cmake .. -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.NDK_PATH }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-35 \
            -DFLATBUFFERS_BUILD_TESTS=OFF \
            -DFLATBUFFERS_BUILD_SHAREDLIB=OFF \
            -DCMAKE_BUILD_TYPE=Release
          ninja

      - name: Build Compute Library (ACL Static)
        run: |
          cd ComputeLibrary
          mkdir -p build && cd build
          # Gunakan CMake untuk stabilitas toolchain NDK
          cmake .. -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.NDK_PATH }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-35 \
            -DARM_COMPUTE_GRAPH=ON \
            -DARM_COMPUTE_OPENCL=ON \
            -DBUILD_SHARED_LIBS=OFF \
            -DCMAKE_BUILD_TYPE=Release
          ninja
          # Export path absolut untuk langkah ArmNN
          echo "ACL_LIB_CORE=${{ github.workspace }}/ComputeLibrary/build/libarm_compute.a" >> $GITHUB_ENV
          echo "ACL_LIB_GRAPH=${{ github.workspace }}/ComputeLibrary/build/libarm_compute_graph.a" >> $GITHUB_ENV

      - name: Build ArmNN (Injeksi Path Absolut)
        run: |
          mkdir -p armnn/build && cd armnn/build
          # Strategi: Menyuapi CMake dengan path library yang sudah pasti ada
          cmake .. -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.NDK_PATH }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=arm64-v8a \
            -DANDROID_PLATFORM=android-35 \
            -DCMAKE_BUILD_TYPE=Release \
            -DARMCOMPUTE_ROOT=${{ github.workspace }}/ComputeLibrary \
            -DARMCOMPUTE_BUILD_DIR=${{ github.workspace }}/ComputeLibrary/build \
            -DARMCOMPUTE_LIBRARY_RELEASE=${{ env.ACL_LIB_CORE }} \
            -DARMCOMPUTE_GRAPH_LIBRARY_RELEASE=${{ env.ACL_LIB_GRAPH }} \
            -DFLATBUFFERS_ROOT=${{ github.workspace }}/flatbuffers \
            -DFLATBUFFERS_LIBRARY=${{ github.workspace }}/flatbuffers/build/libflatbuffers.a \
            -DARMCOMPUTENEON=1 \
            -DARMCOMPUTECL=1 \
            -DBUILD_UNIT_TESTS=OFF \
            -DCMAKE_CXX_FLAGS="-Wl,-z,max-page-size=16384" \
            -DCMAKE_SHARED_LINKER_FLAGS="-Wl,-z,max-page-size=16384"
          
          # Retry ninja build jika terjadi kegagalan sistem (bukan kesalahan kode)
          retry_ninja=0
          until [ $retry_ninja -ge 3 ]
          do
            ninja && break
            retry_ninja=$((retry_ninja+1))
            echo "Retry Ninja: $retry_ninja"
          done

      - name: Package & Verifikasi
        run: |
          mkdir -p final_release
          if [ -f "armnn/build/libarmnn.so" ]; then
            cp armnn/build/libarmnn.so final_release/
            echo "Build Sukses: File ditemukan."
          else
            echo "ERROR: libarmnn.so tidak ditemukan!"
            exit 1
          fi
          cd final_release
          zip -r ../ArmNN_G85_Android16_Complete.zip .

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ArmNN-Binary-A16
          path: ArmNN_G85_Android16_Complete.zip
