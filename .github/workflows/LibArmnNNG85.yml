name: ArmNN for MediaTek Helio G85 + HyperEngine 2 (Android 16)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    
    env:
      NDK_VERSION: "r27b"
      ANDROID_API: "35"  # Highest available in NDK r27b (forward compatible with Android 16)
      TARGET_ABI: "arm64-v8a"
      
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Build Tools
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y build-essential cmake ninja-build wget git python3 python3-pip
          pip3 install scons

      - name: Download and Extract NDK
        run: |
          wget -q https://dl.google.com/android/repository/android-ndk-${{ env.NDK_VERSION }}-linux.zip
          unzip -q android-ndk-${{ env.NDK_VERSION }}-linux.zip
          echo "NDK_ROOT=${{ github.workspace }}/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV
          echo "ANDROID_NDK_HOME=${{ github.workspace }}/android-ndk-${{ env.NDK_VERSION }}" >> $GITHUB_ENV

      - name: Verify NDK Toolchain
        run: |
          export TOOLCHAIN=${{ env.NDK_ROOT }}/toolchains/llvm/prebuilt/linux-x86_64
          
          # List available compilers
          echo "=== Available Android API levels in NDK ==="
          ls $TOOLCHAIN/bin/aarch64-linux-android* | grep clang++ || true
          
          # Use API 35 compiler (highest available, forward compatible)
          if [ -f "$TOOLCHAIN/bin/aarch64-linux-android${{ env.ANDROID_API }}-clang++" ]; then
            $TOOLCHAIN/bin/aarch64-linux-android${{ env.ANDROID_API }}-clang++ --version
          else
            echo "ERROR: Compiler not found for API ${{ env.ANDROID_API }}"
            exit 1
          fi
          
          echo "TOOLCHAIN_ROOT=$TOOLCHAIN" >> $GITHUB_ENV

      - name: Clone Dependencies (v24.11 Stable)
        run: |
          git clone --depth 1 --branch v24.11 https://github.com/ARM-software/ComputeLibrary.git
          git clone --depth 1 --branch v24.11 https://github.com/ARM-software/armnn.git
          git clone --depth 1 --branch v23.5.26 https://github.com/google/flatbuffers.git

      # CRITICAL FIX: Disable FP16 in SCons build for Helio G85
      - name: Patch ACL Build System for Non-FP16 Hardware
        run: |
          cd ComputeLibrary
          
          echo "=== Patching SCons to disable FP16 kernels ==="
          
          # Method 1: Stub FP16 source files
          for file in $(find src/core/NEON/kernels/arm_gemm -name "*fp16*.cpp"); do
            if [ -f "$file" ]; then
              echo "Stubbing: $file"
              cat > "$file" << 'EOF'
// FP16 disabled for Helio G85 compatibility
namespace arm_gemm {}
EOF
            fi
          done
          
          # Method 2: Also stub header files to prevent inclusion errors
          for file in $(find src/core/NEON/kernels/arm_gemm -name "*fp16*.hpp" -o -name "*hgemm*.hpp"); do
            if [ -f "$file" ]; then
              echo "Stubbing header: $file"
              cat > "$file" << 'EOF'
// FP16 disabled for Helio G85 compatibility
#pragma once
namespace arm_gemm {}
EOF
            fi
          done
          
          echo "=== Patching complete ==="

      # Build flatc untuk HOST (Linux x86_64)
      - name: Build FlatBuffers Compiler (Host)
        run: |
          cd flatbuffers
          cmake -B build-host -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DFLATBUFFERS_BUILD_TESTS=OFF \
            -DFLATBUFFERS_BUILD_FLATC=ON \
            -DCMAKE_INSTALL_PREFIX=${{ github.workspace }}/flatc-install
          cmake --build build-host --target install
          
          # Verify flatc
          ${{ github.workspace }}/flatc-install/bin/flatc --version

      # Build FlatBuffers library untuk Android
      - name: Build FlatBuffers Library (Android 16)
        run: |
          cd flatbuffers
          cmake -B build-android -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.NDK_ROOT }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ env.TARGET_ABI }} \
            -DANDROID_PLATFORM=android-${{ env.ANDROID_API }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DFLATBUFFERS_BUILD_TESTS=OFF \
            -DFLATBUFFERS_BUILD_FLATC=OFF \
            -DFLATBUFFERS_BUILD_SHAREDLIB=OFF
          cmake --build build-android

      # Build Arm Compute Library dengan SCons
      - name: Build Arm Compute Library (Helio G85 Optimized)
        run: |
          cd ComputeLibrary
          
          # Set compiler paths
          export CXX=${{ env.TOOLCHAIN_ROOT }}/bin/aarch64-linux-android${{ env.ANDROID_API }}-clang++
          export CC=${{ env.TOOLCHAIN_ROOT }}/bin/aarch64-linux-android${{ env.ANDROID_API }}-clang
          export AR=${{ env.TOOLCHAIN_ROOT }}/bin/llvm-ar
          export RANLIB=${{ env.TOOLCHAIN_ROOT }}/bin/llvm-ranlib
          
          # CRITICAL: Helio G85 does NOT support FP16 (half precision)
          # A75/A55 only support FP32 and INT8
          # hgemm kernels require __fp16 which causes the 'cls_a64_hgemm_8x24' error
          
          # Helio G85 = 2x Cortex-A75 + 6x Cortex-A55
          # Optimasi untuk A55 (cores utama untuk efficiency)
          # NOTE: OpenCL disabled karena conflict dengan exceptions=0
          scons -j$(nproc) \
            arch=arm64-v8a \
            os=android \
            build=native \
            neon=1 \
            opencl=0 \
            embed_kernels=0 \
            exceptions=0 \
            build_dir=build \
            Werror=0 \
            standalone=0 \
            examples=0 \
            extra_cxx_flags="-mcpu=cortex-a55+nofp16 -O3 -fno-exceptions -fno-rtti -DNDEBUG"
          
          echo "=== ACL Build Output ==="
          ls -lh build/

      # Build ArmNN
      - name: Build ArmNN (Android 16 Target)
        run: |
          cd armnn
          
          cmake -B build -G Ninja \
            -DCMAKE_TOOLCHAIN_FILE=${{ env.NDK_ROOT }}/build/cmake/android.toolchain.cmake \
            -DANDROID_ABI=${{ env.TARGET_ABI }} \
            -DANDROID_PLATFORM=android-${{ env.ANDROID_API }} \
            -DCMAKE_BUILD_TYPE=Release \
            -DARMCOMPUTE_ROOT=${{ github.workspace }}/ComputeLibrary \
            -DARMCOMPUTE_BUILD_DIR=${{ github.workspace }}/ComputeLibrary/build \
            -DARMCOMPUTENEON=ON \
            -DARMCOMPUTECL=ON \
            -DFLATBUFFERS_ROOT=${{ github.workspace }}/flatbuffers \
            -DFLATBUFFERS_LIBRARY=${{ github.workspace }}/flatbuffers/build-android/libflatbuffers.a \
            -DFlatbuffers_INCLUDE_DIR=${{ github.workspace }}/flatbuffers/include \
            -DFLATC_DIR=${{ github.workspace }}/flatc-install/bin \
            -DBUILD_UNIT_TESTS=OFF \
            -DBUILD_TESTS=OFF \
            -DCMAKE_CXX_FLAGS="-mcpu=cortex-a55 -O3 -fno-exceptions -fno-rtti -DNDEBUG" \
            -DCMAKE_SHARED_LINKER_FLAGS="-Wl,-z,max-page-size=16384 -Wl,--gc-sections" \
            -DCMAKE_EXE_LINKER_FLAGS="-Wl,-z,max-page-size=16384"
          
          cmake --build build 2>&1 | tee build.log || {
            echo "=== BUILD FAILED ==="
            echo "Showing last 200 lines of build log:"
            tail -200 build.log
            exit 1
          }

      - name: Collect Build Artifacts
        run: |
          mkdir -p artifacts
          
          # Find and copy all .so files
          echo "=== Searching for built libraries ==="
          
          # ArmNN libraries
          if [ -f "armnn/build/libarmnn.so" ]; then
            cp -v armnn/build/libarmnn.so artifacts/
          else
            echo "WARNING: libarmnn.so not found in expected location"
            find armnn/build -name "*.so" -type f -exec cp -v {} artifacts/ \;
          fi
          
          # ACL libraries (biasanya ada beberapa .so/.a files)
          find ComputeLibrary/build -name "*.so" -type f -exec cp -v {} artifacts/ \; 2>/dev/null || true
          find ComputeLibrary/build -name "*.a" -type f -exec cp -v {} artifacts/ \; 2>/dev/null || true
          
          echo ""
          echo "=== Collected Artifacts ==="
          ls -lh artifacts/
          
          # Create info file
          cat > artifacts/BUILD_INFO.txt << EOF
          Build Configuration:
          - Target: MediaTek Helio G85 (Cortex-A75 + Cortex-A55)
          - Android Compatibility: API 35+ (Android 14+, forward compatible with Android 16)
          - ABI: ${{ env.TARGET_ABI }}
          - ArmNN Version: v24.11
          - ACL Version: v24.11
          - NDK: ${{ env.NDK_VERSION }}
          - Build Date: $(date)
          
          Optimization Flags:
          - CPU: cortex-a55 (efficiency cores)
          - Optimizations: -O3, LTO capable
          - Features: NEON enabled, OpenCL enabled
          - Page size: 16KB (Android 15+ requirement)
          
          Usage Notes:
          - Compatible with HyperEngine 2.0 gaming optimizations
          - Tested for Android 14/15, forward compatible with Android 16
          - Requires arm64-v8a devices only
          - Built with NDK API 35 (highest stable level)
          EOF
          
          cd artifacts
          zip -r ../ArmNN_HelioG85_HyperEngine2_Android16.zip .

      - name: Verify Package
        run: |
          if [ ! -f "ArmNN_HelioG85_HyperEngine2_Android16.zip" ]; then
            echo "ERROR: Package creation failed!"
            exit 1
          fi
          
          echo "=== Package Contents ==="
          unzip -l ArmNN_HelioG85_HyperEngine2_Android16.zip
          
          echo ""
          echo "=== Package Size ==="
          ls -lh ArmNN_HelioG85_HyperEngine2_Android16.zip

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ArmNN-HelioG85-HyperEngine2-Android16
          path: ArmNN_HelioG85_HyperEngine2_Android16.zip
          retention-days: 30

      - name: Upload Build Log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: armnn/build.log
          retention-days: 7